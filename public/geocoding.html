<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒí¬ê³¨í”„ì¥ ì§€ì˜¤ì½”ë”©</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0e0864229b42ff2775b3a82802207f66&libraries=services"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #4CAF50;
            height: 100%;
            transition: width 0.3s;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>ğŸŒ íŒŒí¬ê³¨í”„ì¥ ì¢Œí‘œ ì§€ì˜¤ì½”ë”©</h1>
    
    <div class="stats">
        <div class="stat-box">
            <div class="stat-number" id="totalCount">-</div>
            <div>ì „ì²´</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="missingCount">-</div>
            <div>ì¢Œí‘œ ì—†ìŒ</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="successCount">0</div>
            <div>ë³€í™˜ ì„±ê³µ</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="failCount">0</div>
            <div>ë³€í™˜ ì‹¤íŒ¨</div>
        </div>
    </div>

    <div>
        <button onclick="loadData()">ë°ì´í„° ë¡œë“œ</button>
        <button onclick="startGeocodingTest()" id="testBtn" disabled>í…ŒìŠ¤íŠ¸ (5ê°œ)</button>
        <button onclick="startGeocodingAll()" id="allBtn" disabled>ì „ì²´ ì§€ì˜¤ì½”ë”©</button>
        <button onclick="downloadResults()" id="downloadBtn" disabled>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    <div id="progressText">ëŒ€ê¸° ì¤‘...</div>

    <div class="log" id="logArea">
        ì¤€ë¹„ë¨. 'ë°ì´í„° ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
    </div>

    <script>
        let allCourses = [];
        let missingCoords = [];
        let geocodedResults = [];
        let isRunning = false;

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logArea.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                log('KPGA ë°ì´í„° ë¡œë“œ ì¤‘...');
                const response = await fetch('/data/kpga-all-courses.json');
                const data = await response.json();
                
                allCourses = data;
                missingCoords = data.filter(course => 
                    !course.latitude || 
                    !course.longitude || 
                    course.latitude === '' || 
                    course.longitude === '' ||
                    isNaN(parseFloat(course.latitude)) ||
                    isNaN(parseFloat(course.longitude))
                );

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalCount').textContent = allCourses.length;
                document.getElementById('missingCount').textContent = missingCoords.length;
                
                log(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ì „ì²´ ${allCourses.length}ê°œ, ì¢Œí‘œ ì—†ìŒ ${missingCoords.length}ê°œ`, 'success');
                
                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('testBtn').disabled = false;
                document.getElementById('allBtn').disabled = false;

                // ì²˜ìŒ 10ê°œ ë¯¸ë¦¬ë³´ê¸°
                log('ì¢Œí‘œ ì—†ëŠ” íŒŒí¬ê³¨í”„ì¥ ì²˜ìŒ 10ê°œ:');
                missingCoords.slice(0, 10).forEach((course, i) => {
                    log(`  ${i + 1}. ${course.ì‹œì„¤ëª…} (${course.ì£¼ì†Œ}) - ${course.ì§€ì—­}`);
                });

            } catch (error) {
                log(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ê°œë³„ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©
        function geocodeAddress(address) {
            return new Promise((resolve) => {
                const geocoder = new kakao.maps.services.Geocoder();
                
                // ì£¼ì†Œ ì •ë¦¬
                const cleanAddress = address
                    .replace(/\(.*?\)/g, '') // ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±°
                    .replace(/\s+/g, ' ')     // ì—°ì† ê³µë°± ì •ë¦¬
                    .trim();

                geocoder.addressSearch(cleanAddress, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const coords = result[0];
                        resolve({
                            latitude: parseFloat(coords.y),
                            longitude: parseFloat(coords.x),
                            success: true
                        });
                    } else {
                        resolve({
                            latitude: null,
                            longitude: null,
                            success: false
                        });
                    }
                });
            });
        }

        // ë°°ì¹˜ ì§€ì˜¤ì½”ë”©
        async function batchGeocode(courses, isTest = false) {
            const results = [];
            const total = courses.length;
            let successCount = 0;
            let failCount = 0;

            isRunning = true;
            updateButtons();

            for (let i = 0; i < courses.length; i++) {
                if (!isRunning) break; // ì¤‘ë‹¨ë¨

                const course = courses[i];
                const progress = ((i + 1) / total) * 100;
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `ì§„í–‰ì¤‘: ${i + 1}/${total} (${progress.toFixed(1)}%) - ${course.ì‹œì„¤ëª…}`;

                log(`[${i + 1}/${total}] ${course.ì‹œì„¤ëª…} - ${course.ì£¼ì†Œ}`);

                const geocodeResult = await geocodeAddress(course.ì£¼ì†Œ);
                
                const updatedCourse = {
                    ...course,
                    latitude: geocodeResult.latitude,
                    longitude: geocodeResult.longitude,
                    ê¸°ì¡´ë§¤ì¹­: geocodeResult.success ? 'ì§€ì˜¤ì½”ë”©' : course.ê¸°ì¡´ë§¤ì¹­
                };

                results.push(updatedCourse);

                if (geocodeResult.success) {
                    successCount++;
                    log(`  âœ“ ì„±ê³µ: ${geocodeResult.latitude}, ${geocodeResult.longitude}`, 'success');
                } else {
                    failCount++;
                    log(`  âœ— ì‹¤íŒ¨: ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`, 'error');
                }

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failCount').textContent = failCount;

                // API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ ì§€ì—° (500ms)
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            isRunning = false;
            updateButtons();

            const finalSuccessRate = total > 0 ? (successCount / total * 100).toFixed(1) : 0;
            log(`\n=== ${isTest ? 'í…ŒìŠ¤íŠ¸' : 'ì§€ì˜¤ì½”ë”©'} ì™„ë£Œ ===`, 'success');
            log(`ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ, ì„±ê³µë¥ : ${finalSuccessRate}%`, 'success');

            return results;
        }

        // í…ŒìŠ¤íŠ¸ ì§€ì˜¤ì½”ë”© (5ê°œë§Œ)
        async function startGeocodingTest() {
            if (missingCoords.length === 0) {
                log('ì¢Œí‘œê°€ ì—†ëŠ” íŒŒí¬ê³¨í”„ì¥ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            log('\n=== í…ŒìŠ¤íŠ¸ ì§€ì˜¤ì½”ë”© ì‹œì‘ (5ê°œ) ===');
            const testCourses = missingCoords.slice(0, 5);
            geocodedResults = await batchGeocode(testCourses, true);
        }

        // ì „ì²´ ì§€ì˜¤ì½”ë”©
        async function startGeocodingAll() {
            if (missingCoords.length === 0) {
                log('ì¢Œí‘œê°€ ì—†ëŠ” íŒŒí¬ê³¨í”„ì¥ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            if (!confirm(`ì´ ${missingCoords.length}ê°œì˜ ì£¼ì†Œë¥¼ ì§€ì˜¤ì½”ë”©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
                return;
            }

            log('\n=== ì „ì²´ ì§€ì˜¤ì½”ë”© ì‹œì‘ ===');
            geocodedResults = await batchGeocode(missingCoords);
            
            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('downloadBtn').disabled = false;
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadResults() {
            if (geocodedResults.length === 0) {
                log('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            // ì „ì²´ ë°ì´í„°ì— ì§€ì˜¤ì½”ë”© ê²°ê³¼ í†µí•©
            const updatedCourses = allCourses.map(course => {
                const geocoded = geocodedResults.find(gc => gc.ì‹œì„¤ëª… === course.ì‹œì„¤ëª…);
                return geocoded || course;
            });

            // JSON ë‹¤ìš´ë¡œë“œ
            const jsonData = JSON.stringify(updatedCourses, null, 2);
            downloadFile('kpga-all-courses-geocoded.json', jsonData, 'application/json');

            // CSV ë‹¤ìš´ë¡œë“œ
            const csvData = convertToCSV(updatedCourses);
            downloadFile('kpga-all-courses-geocoded.csv', csvData, 'text/csv');

            log('ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼
        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // CSV ë³€í™˜
        function convertToCSV(data) {
            const headers = ['ì—°ë²ˆ', 'ì‹œì„¤ëª…', 'ìœ„ì¹˜', 'ê·œëª¨', 'í™€ìˆ˜', 'ìš´ì˜ê¸°ê´€', 'ì—°ë½ì²˜', 'latitude', 'longitude', 'ì§€ì—­', 'ê¸°ì¡´ë§¤ì¹­'];
            const csvRows = [headers.join(',')];
            
            data.forEach((row, index) => {
                const values = [
                    index + 1,
                    `"${row.ì‹œì„¤ëª… || ''}"`,
                    `"${row.ì£¼ì†Œ || ''}"`,
                    `"${row.ê·œëª¨ || ''}"`,
                    `"${row.í™€ìˆ˜ || ''}"`,
                    `"${row.ìš´ì˜ê¸°ê´€ || ''}"`,
                    `"${row.ì—°ë½ì²˜ || ''}"`,
                    row.latitude || '',
                    row.longitude || '',
                    `"${row.ì§€ì—­ || ''}"`,
                    `"${row.ê¸°ì¡´ë§¤ì¹­ || 'ì‹ ê·œ'}"`
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateButtons() {
            document.getElementById('testBtn').disabled = isRunning;
            document.getElementById('allBtn').disabled = isRunning;
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì¹´ì¹´ì˜¤ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
        window.onload = function() {
            if (typeof kakao === 'undefined') {
                log('ì¹´ì¹´ì˜¤ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨', 'error');
            } else {
                log('ì¹´ì¹´ì˜¤ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ', 'success');
            }
        };
    </script>
</body>
</html>
